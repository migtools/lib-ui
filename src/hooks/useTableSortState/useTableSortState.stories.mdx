import { Meta, Story, Canvas, ArgsTable } from '@storybook/addon-docs/blocks';
import { useTableSortState } from './useTableSortState';
import {
  StandaloneByValue,
  StandaloneByFunction,
  ComposableTableSorting,
  LegacyTableSorting,
} from './useTableSortState.stories.tsx';
import GithubLink from '../../../.storybook/helpers/GithubLink';

<Meta title="Hooks/useTableSortState" component={useTableSortState} />

# useTableSortState

A custom hook for sorting tabular data which manages the state of the active column and sort direction internally.

Given any array of items representing data to be rendered in a table and either a `getSortValues` function or a `compareFn` to specify
sorting logic for each column, this hook returns the sorted array, sort selections, and callbacks for updating the sort selections.

Supports passing a TypeScript type for the table items using [generics](https://www.typescriptlang.org/docs/handbook/generics.html).

```ts
// Syntax:
const sortState = useTableSortState<T>(args: TableSortStateArgs<T>);

// Arguments (simplified, see discriminated union in source):
type TableSortStateArgs<T> {
  items: T[];
  initialSortColumnIndex?: number | null; // Defaults to null
  initialSortDirection?: 'asc' | 'desc'; // Defaults to 'asc'
  // One or the other of getSortValues or compareFn is required:
  getSortValues: (item: T) => (string | number | boolean)[];
  compareFn: (itemA: T, itemB: T, sortColumnIndex: number, sortDirection: 'asc' | 'desc') => number;
}

// Return value:
interface ITableSortStateHook<T> {
  sortedItems: T[];
  sortColumnIndex: number | null;
  setSortColumnIndex: React.Dispatch<React.SetStateAction<number | null>>;
  sortDirection: 'asc' | 'desc';
  setSortDirection: React.Dispatch<React.SetStateAction<'asc' | 'desc'>>;
  reset: () => void; // sets sortColumnIndex to initialSortColumnIndex and sortDirection to initialSortDirection
  tableSortProps: { // To simplify use with PatternFly
    sortBy: ISortBy;
    onSort: (event: React.SyntheticEvent, index: number, direction: SortByDirection) => void;
  };
}
```

The `sortedItems` array returned from the hook should be used to render the contents of your table, or be passed to another hook like `usePaginationState`
to further process your data before rendering.

## A note about pagination

If you are also performing pagination of your data, be sure to sort your data before you paginate it. Using the `currentPageItems`
returned from `usePaginationState` as the `items` argument for `useTableSortState` will cause an inconsistent sort order.
If you are using these two hooks together, call `useTableSortState` first and then pass the `sortedItems` into `usePaginationState` as its `items` argument.
Pagination should be the last thing you do to your data before rendering it.

## Standalone examples

These examples use the hook alone with some custom controls to demonstrate that it doesn't need to be coupled to the PatternFly table.

### Simple sorting (using `getSortValues`)

This example uses the `getSortValues` option, which is the simplest way to use `useTableSortState`.
We simply pass a function that takes an item and returns an array of primitive values for each column,
and those values are compared using `<` and `>` operators to perform the sorting.

Most of the time `getSortValues` should return the same cells that are rendered in the table for that item's row,
but if you're doing some custom rendering in one of your columns you would return a simple sortable version of the value here.

<Canvas>
  <Story story={StandaloneByValue} />
</Canvas>

### Custom sorting (using `compareFn`)

This example passes a `compareFn` instead of `getSortValues` in order to customize the sorting logic. The `compareFn`'s return value
follows the rules for the return value of the callback in [JavaScript's Array.prototype.sort() method](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/sort),
except it also takes the `sortColumnIndex` and `sortDirection` for use in your custom logic.

Either `compareFn` or `getSortValues` is required, but they can't be used together; TypeScript will give an error if you pass neither or both.

<Canvas>
  <Story story={StandaloneByFunction} />
</Canvas>

## PatternFly Table examples

These examples use the `tableSortProps` return value as a convenient way to plug the hook into [PatternFly's table components](https://www.patternfly.org/v4/components/table).
This object contains the `sortBy` and `onSort` props expected by PatternFly so you don't have to manage the `sortColumnIndex` and `sortDirection` yourself.

### Composable Table

PatternFly's newer `TableComposable` component is preferred because of its rendering flexibility.
To use it, spread `tableSortProps` into the `sort` prop of each `Th` component along with a `columnIndex` property.

<Canvas>
  <Story story={ComposableTableSorting} />
</Canvas>

### Legacy Table

PatternFly's older config-driven `Table` component is also supported. To use it, simply spread `tableSortProps` directly into the `<Table>`.

Note: the items passed into `useTableSortState` should be your underlying data, not the array of rows you're passing into the `Table` component.
The rows array expected by `Table` should be defined at render time based on the results of the sorting and any other manipulation of your data (e.g. filtering and pagination),
and not stored in your component state.

<Canvas>
  <Story story={LegacyTableSorting} />
</Canvas>

<GithubLink path="src/hooks/useTableSortState/useTableSortState.ts" />
